<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>房贷提前还本计算器</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 30px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .description {
            color: #7f8c8d;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .calculator-section {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .input-section {
            flex: 1;
            min-width: 300px;
        }
        
        .result-section {
            flex: 1;
            min-width: 300px;
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .section-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .method-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .method-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .method-btn:hover {
            border-color: #3498db;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
        }
        
        .radio-option input {
            width: auto;
            margin-right: 8px;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 14px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .calculate-btn {
            background-color: #3498db;
            color: white;
        }
        
        .calculate-btn:hover {
            background-color: #2980b9;
        }
        
        .export-btn {
            background-color: #27ae60;
            color: white;
        }
        
        .export-btn:hover {
            background-color: #219653;
        }
        
        .reset-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .reset-btn:hover {
            background-color: #c0392b;
        }
        
        .result-item {
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .result-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .result-value {
            font-size: 1.2rem;
            color: #27ae60;
            font-weight: 700;
            line-height: 1.5;
        }
        
        .result-note {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .highlight {
            background-color: #e8f4fc;
            border-left: 4px solid #3498db;
        }
        
        .table-section {
            margin-top: 40px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            text-align: left;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .footer {
            margin-top: 40px;
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9rem;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .interest-breakdown {
            font-size: 1rem;
            color: #2c3e50;
            font-weight: normal;
        }
        
        .repayment-plan-section {
            margin-top: 40px;
        }
        
        .export-plan-btn {
            margin-top: 15px;
            background-color: #9b59b6;
            color: white;
        }
        
        .export-plan-btn:hover {
            background-color: #8e44ad;
        }
        
        @media (max-width: 768px) {
            .calculator-section {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>房贷提前还本计算器</h1>
            <p class="description">本计算器支持等额本息和等额本金两种还款方式，可帮助您计算房贷提前还本后的新还款计划，支持两种还款方案：减少月供（年限不变）或减少年限（月供不变），可为您预测两种还款方案能节省的利息支出</p>
        </header>
        
        <div class="calculator-section">
            <div class="input-section">
                <h2 class="section-title">输入参数</h2>
                
                <div class="form-group">
                    <label for="remainingPrincipal">一、剩余本金余额（元）</label>
                    <input type="number" id="remainingPrincipal" min="0" step="1000" value="500000">
                </div>
                
                <div class="form-group">
                    <label>二、还款方式</label>
                    <div class="button-group" id="repaymentMethodGroup">
                        <div class="method-btn active" data-value="等额本息">等额本息</div>
                        <div class="method-btn" data-value="等额本金">等额本金</div>
                    </div>
                    <input type="hidden" id="repaymentMethod" value="等额本息">
                </div>
                
                <div class="form-group">
                    <label for="remainingPeriods">三、剩余还款期数（月）</label>
                    <input type="number" id="remainingPeriods" min="1" step="1" value="240">
                </div>
                
                <div class="form-group">
                    <label for="annualRate">四、年利率（%）</label>
                    <input type="number" id="annualRate" min="0.1" max="20" step="0.01" value="4.9">
                </div>
                
                <div class="form-group">
                    <label for="monthlyPayment">五、当前每月月供（元）</label>
                    <input type="number" id="monthlyPayment" min="0" step="0.01" value="3272.22">
                </div>
                
                <div class="form-group">
                    <label for="paymentDay">六、当前每月月供还款日</label>
                    <select id="paymentDay">
                        <option value="每月1日">每月1日</option>
                        <option value="每月2日">每月2日</option>
                        <option value="每月3日">每月3日</option>
                        <option value="每月4日">每月4日</option>
                        <option value="每月5日">每月5日</option>
                        <option value="每月6日">每月6日</option>
                        <option value="每月7日">每月7日</option>
                        <option value="每月8日">每月8日</option>
                        <option value="每月9日">每月9日</option>
                        <option value="每月10日">每月10日</option>
                        <option value="每月11日">每月11日</option>
                        <option value="每月12日">每月12日</option>
                        <option value="每月13日">每月13日</option>
                        <option value="每月14日">每月14日</option>
                        <option value="每月15日" selected>每月15日</option>
                        <option value="每月16日">每月16日</option>
                        <option value="每月17日">每月17日</option>
                        <option value="每月18日">每月18日</option>
                        <option value="每月19日">每月19日</option>
                        <option value="每月20日">每月20日</option>
                        <option value="每月21日">每月21日</option>
                        <option value="每月22日">每月22日</option>
                        <option value="每月23日">每月23日</option>
                        <option value="每月24日">每月24日</option>
                        <option value="每月25日">每月25日</option>
                        <option value="每月26日">每月26日</option>
                        <option value="每月27日">每月27日</option>
                        <option value="每月28日">每月28日</option>
                        <option value="每月29日">每月29日</option>
                        <option value="每月30日">每月30日</option>
                        <option value="每月31日">每月31日</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="prepayAmount">七、提前还本金额（元）</label>
                    <input type="number" id="prepayAmount" min="0" step="1000" value="100000">
                </div>
                
                <div class="form-group">
                    <label for="prepayDate">八、提前还本日期</label>
                    <input type="date" id="prepayDate" value="2023-10-15">
                </div>
                
                <div class="form-group">
                    <label>九、还款方案</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="reducePayment" name="repaymentPlan" value="reducePayment" checked>
                            <label for="reducePayment">减少月供，年限不变</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="reducePeriod" name="repaymentPlan" value="reducePeriod">
                            <label for="reducePeriod">减少年限，月供不变</label>
                        </div>
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="calculate-btn" id="calculateBtn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 9H6C4.34315 9 3 10.3431 3 12V18C3 19.6569 4.34315 21 6 21H18C19.6569 21 21 19.6569 21 18V12C21 10.3431 19.6569 9 18 9H15M9 9V3H15V9M9 9H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        计算
                    </button>
                    <button class="export-btn" id="exportBtn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13 2H6C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V9M13 2L20 9M13 2V9H20M16 13H8M16 17H8M10 9H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        导出Excel
                    </button>
                    <button class="reset-btn" id="resetBtn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 4V9H4.58152M19.9381 11C19.446 7.05369 16.0796 4 12 4C8.64262 4 5.76829 6.06817 4.58152 9M4.58152 9H9M20 20V15H19.4185M19.4185 15C18.2317 17.9318 15.3574 20 12 20C7.92038 20 4.55399 16.9463 4.06189 13M19.4185 15H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        重置
                    </button>
                </div>
            </div>
            
            <div class="result-section">
                <h2 class="section-title">计算结果</h2>
                <div id="resultsContainer">
                    <div class="result-item highlight">
                        <div class="result-label">调整后结果</div>
                        <div class="result-value" id="adjustedResult">请点击计算按钮</div>
                        <div class="result-note" id="resultNote">根据您选择的还款方案，将显示新月供金额或新剩余期数</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">节省利息总额</div>
                        <div class="result-value" id="interestSaved">--</div>
                        <div class="result-note">提前还款后节省的总利息</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">缩期与缩额利差</div>
                        <div class="result-value" id="interestDifference">--</div>
                        <div class="result-note">减少年限方案比减少月供方案多节省的利息</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">原还款计划总额</div>
                        <div class="result-value" id="originalTotal">--</div>
                        <div class="result-note">包含剩余本金和利息</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">新还款计划总额</div>
                        <div class="result-value" id="newTotal">--</div>
                        <div class="result-note">提前还款后的本金+利息总额</div>
                    </div>
                    
                    <div class="result-item">
                        <div class="result-label">剩余本金减少比例</div>
                        <div class="result-value" id="principalReduction">--</div>
                        <div class="result-note">提前还款金额占剩余本金的比例</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-section">
            <h2 class="section-title">计算结果详情</h2>
            <table id="resultTable">
                <thead>
                    <tr>
                        <th>剩余本金余额(元)</th>
                        <th>还款方式</th>
                        <th>剩余还款期数(月)</th>
                        <th>年利率(%)</th>
                        <th>当前每月月供(元)</th>
                        <th>当前每月月供还款日</th>
                        <th>提前还本金额(元)</th>
                        <th>提前还本日期</th>
                        <th>还款方案</th>
                        <th>调整后结果(新月供/新期数)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="10" style="text-align: center;">请先进行计算</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="repayment-plan-section">
            <h2 class="section-title">调整后的还款计划表</h2>
            <div style="overflow-x: auto;">
                <table id="repaymentPlanTable">
                    <thead>
                        <tr>
                            <th>还款期次</th>
                            <th>每月还款日期</th>
                            <th>每期还款额(元)</th>
                            <th>应还本金(元)</th>
                            <th>应还利息(元)</th>
                            <th>本金余额(元)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" style="text-align: center;">请先进行计算</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <button class="export-plan-btn" id="exportPlanBtn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13 2H6C4.89543 2 4 2.89543 4 4V20C4 21.1046 4.89543 22 6 22H18C19.1046 22 20 21.1046 20 20V9M13 2L20 9M13 2V9H20M16 13H8M16 17H8M10 9H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                导出还款计划Excel
            </button>
        </div>
        
        <div class="footer">
            <p>房贷提前还本计算器 Version 1.0.0.2 | 计算结果仅供参考，实际还款金额请以银行或公积金系统计算为准。版权所有  违者必究！</p>
        </div>
    </div>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script>
        // 页面加载时设置默认日期为今天
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('prepayDate').value = formattedDate;
            
            // 计算当前月供
            calculateMonthlyPayment();
            
            // 监听还款方式按钮点击事件
            const methodButtons = document.querySelectorAll('#repaymentMethodGroup .method-btn');
            methodButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 移除所有按钮的active类
                    methodButtons.forEach(btn => btn.classList.remove('active'));
                    // 给当前点击的按钮添加active类
                    this.classList.add('active');
                    // 更新隐藏的input值
                    document.getElementById('repaymentMethod').value = this.getAttribute('data-value');
                    // 重新计算月供
                    calculateMonthlyPayment();
                });
            });
        });
        
        // 计算当前月供
        function calculateMonthlyPayment() {
            const principal = parseFloat(document.getElementById('remainingPrincipal').value);
            const annualRate = parseFloat(document.getElementById('annualRate').value);
            const periods = parseInt(document.getElementById('remainingPeriods').value);
            const repaymentMethod = document.getElementById('repaymentMethod').value;
            
            if (principal && annualRate && periods) {
                const monthlyRate = annualRate / 100 / 12;
                let monthlyPayment;
                
                if (repaymentMethod === '等额本息') {
                    // 等额本息计算公式
                    monthlyPayment = principal * monthlyRate * Math.pow(1 + monthlyRate, periods) / 
                                  (Math.pow(1 + monthlyRate, periods) - 1);
                } else {
                    // 等额本金计算公式：每月还款本金相同，利息逐月递减
                    // 首月月供 = (本金/期数) + (本金 × 月利率)
                    const monthlyPrincipal = principal / periods;
                    monthlyPayment = monthlyPrincipal + principal * monthlyRate;
                }
                
                document.getElementById('monthlyPayment').value = monthlyPayment.toFixed(2);
            }
        }
        
        // 监听输入变化，自动计算月供
        document.getElementById('remainingPrincipal').addEventListener('change', calculateMonthlyPayment);
        document.getElementById('annualRate').addEventListener('change', calculateMonthlyPayment);
        document.getElementById('remainingPeriods').addEventListener('change', calculateMonthlyPayment);
        
        // 计算按钮点击事件
        document.getElementById('calculateBtn').addEventListener('click', function() {
            calculate();
        });
        
        // 重置按钮点击事件
        document.getElementById('resetBtn').addEventListener('click', function() {
            document.getElementById('remainingPrincipal').value = '500000';
            document.getElementById('remainingPeriods').value = '240';
            document.getElementById('annualRate').value = '4.9';
            document.getElementById('paymentDay').value = '每月15日';
            document.getElementById('prepayAmount').value = '100000';
            
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('prepayDate').value = formattedDate;
            
            document.getElementById('reducePayment').checked = true;
            
            // 重置还款方式按钮
            const methodButtons = document.querySelectorAll('#repaymentMethodGroup .method-btn');
            methodButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector('#repaymentMethodGroup .method-btn[data-value="等额本息"]').classList.add('active');
            document.getElementById('repaymentMethod').value = '等额本息';
            
            calculateMonthlyPayment();
            
            // 重置结果
            document.getElementById('adjustedResult').textContent = '请点击计算按钮';
            document.getElementById('resultNote').textContent = '根据您选择的还款方案，将显示新月供金额或新剩余期数';
            document.getElementById('interestSaved').textContent = '--';
            document.getElementById('interestDifference').textContent = '--';
            document.getElementById('originalTotal').textContent = '--';
            document.getElementById('newTotal').textContent = '--';
            document.getElementById('principalReduction').textContent = '--';
            
            const tableBody = document.querySelector('#resultTable tbody');
            tableBody.innerHTML = '<tr><td colspan="10" style="text-align: center;">请先进行计算</td></tr>';
            
            // 重置还款计划表
            const planTableBody = document.querySelector('#repaymentPlanTable tbody');
            planTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">请先进行计算</td></tr>';
        });
        
        // 导出按钮点击事件
        document.getElementById('exportBtn').addEventListener('click', exportToExcel);
        
        // 导出还款计划按钮点击事件
        document.getElementById('exportPlanBtn').addEventListener('click', exportPlanToExcel);
        
        // 主要计算函数
        function calculate() {
            // 获取输入值
            const remainingPrincipal = parseFloat(document.getElementById('remainingPrincipal').value);
            const repaymentMethod = document.getElementById('repaymentMethod').value;
            const remainingPeriods = parseInt(document.getElementById('remainingPeriods').value);
            const annualRate = parseFloat(document.getElementById('annualRate').value);
            const monthlyPayment = parseFloat(document.getElementById('monthlyPayment').value);
            const paymentDay = document.getElementById('paymentDay').value;
            const prepayAmount = parseFloat(document.getElementById('prepayAmount').value);
            const prepayDate = document.getElementById('prepayDate').value;
            
            // 获取选择的还款方案
            const repaymentPlan = document.querySelector('input[name="repaymentPlan"]:checked').value;
            const planName = repaymentPlan === 'reducePayment' ? '减少月供，年限不变' : '减少年限，月供不变';
            
            // 验证输入
            if (!remainingPrincipal || !remainingPeriods || !annualRate || !monthlyPayment || !prepayAmount) {
                alert('请填写所有必填字段');
                return;
            }
            
            if (prepayAmount > remainingPrincipal) {
                alert('提前还本金额不能大于剩余本金余额');
                return;
            }
            
            // 计算月利率
            const monthlyRate = annualRate / 100 / 12;
            
            // 计算剩余本金减少比例
            const principalReductionRatio = (prepayAmount / remainingPrincipal * 100).toFixed(2);
            
            let originalTotalPayment, newPrincipal, adjustedResult, newMonthlyPayment, newPeriods, newTotalPayment, interestSaved;
            let originalInterest, newInterest;
            
            // 计算缩期与缩额利差（同时计算两种方案）
            let reducePaymentInterestSaved = 0; // 减少月供方案节省的利息
            let reducePeriodInterestSaved = 0;   // 减少年限方案节省的利息
            let interestDifference = 0;          // 两种方案利息差额
            
            // 计算剩余本金（扣除提前还款）
            newPrincipal = remainingPrincipal - prepayAmount;
            
            // 计算原到期日
            const prepayDateObj = new Date(prepayDate);
            const originalEndDate = calculateEndDate(prepayDateObj, remainingPeriods);
            const originalEndDateStr = formatDate(originalEndDate);
            
            // 存储还款计划数据
            let repaymentPlanData = [];
            
            if (repaymentMethod === '等额本息') {
                // 等额本息计算
                // 计算原还款计划总金额
                originalTotalPayment = monthlyPayment * remainingPeriods;
                
                // 计算原利息总额
                originalInterest = originalTotalPayment - remainingPrincipal;
                
                // 计算减少月供方案（年限不变）
                let reducePaymentNewPeriods = remainingPeriods;
                let reducePaymentNewMonthlyPayment = newPrincipal * monthlyRate * Math.pow(1 + monthlyRate, reducePaymentNewPeriods) / 
                                                   (Math.pow(1 + monthlyRate, reducePaymentNewPeriods) - 1);
                let reducePaymentNewTotal = reducePaymentNewMonthlyPayment * reducePaymentNewPeriods;
                let reducePaymentNewInterest = reducePaymentNewTotal - newPrincipal;
                reducePaymentInterestSaved = originalInterest - reducePaymentNewInterest;
                
                // 计算减少年限方案（月供不变）
                let reducePeriodNewMonthlyPayment = monthlyPayment;
                
                // 检查月供是否足够支付利息
                if (reducePeriodNewMonthlyPayment > newPrincipal * monthlyRate) {
                    let reducePeriodNewPeriods = Math.ceil(Math.log(reducePeriodNewMonthlyPayment / (reducePeriodNewMonthlyPayment - newPrincipal * monthlyRate)) / Math.log(1 + monthlyRate));
                    
                    // 重新计算最后一期月供（因为期数是整数，最后一期可能不同）
                    const lastPayment = newPrincipal * Math.pow(1 + monthlyRate, reducePeriodNewPeriods) - 
                                       reducePeriodNewMonthlyPayment * (Math.pow(1 + monthlyRate, reducePeriodNewPeriods) - 1) / monthlyRate;
                    
                    // 计算新还款计划总金额
                    let reducePeriodNewTotal = reducePeriodNewMonthlyPayment * (reducePeriodNewPeriods - 1) + lastPayment;
                    let reducePeriodNewInterest = reducePeriodNewTotal - newPrincipal;
                    reducePeriodInterestSaved = originalInterest - reducePeriodNewInterest;
                    
                    // 计算两种方案利息差额
                    interestDifference = reducePeriodInterestSaved - reducePaymentInterestSaved;
                    
                    // 计算新到期日
                    const reducePeriodEndDate = calculateEndDate(prepayDateObj, reducePeriodNewPeriods);
                    const reducePeriodEndDateStr = formatDate(reducePeriodEndDate);
                    
                    // 根据用户选择的方案显示对应的结果
                    if (repaymentPlan === 'reducePayment') {
                        // 方案1：减少月供，年限不变
                        adjustedResult = `新月供: ${reducePaymentNewMonthlyPayment.toFixed(2)}元，贷款到期日${originalEndDateStr}。`;
                        newTotalPayment = reducePaymentNewTotal;
                        newInterest = reducePaymentNewInterest;
                        interestSaved = reducePaymentInterestSaved;
                        newMonthlyPayment = reducePaymentNewMonthlyPayment;
                        newPeriods = reducePaymentNewPeriods;
                        
                        // 生成等额本息还款计划
                        repaymentPlanData = generateEqualPrincipalAndInterestSchedule(
                            newPrincipal, monthlyRate, newPeriods, newMonthlyPayment, 
                            prepayDateObj, paymentDay
                        );
                    } else {
                        // 方案2：减少年限，月供不变
                        const periodReduction = remainingPeriods - reducePeriodNewPeriods;
                        adjustedResult = `新剩余期数: ${reducePeriodNewPeriods}个月，比原期数减少${periodReduction}个月，贷款到期日${reducePeriodEndDateStr}。`;
                        newTotalPayment = reducePeriodNewTotal;
                        newInterest = reducePeriodNewInterest;
                        interestSaved = reducePeriodInterestSaved;
                        newMonthlyPayment = reducePeriodNewMonthlyPayment;
                        newPeriods = reducePeriodNewPeriods;
                        
                        // 生成等额本息还款计划（最后一期不同）
                        repaymentPlanData = generateEqualPrincipalAndInterestScheduleWithLastPayment(
                            newPrincipal, monthlyRate, newPeriods, newMonthlyPayment, 
                            lastPayment, prepayDateObj, paymentDay
                        );
                    }
                } else {
                    // 月供不足以支付利息，无法计算减少年限方案
                    if (repaymentPlan === 'reducePeriod') {
                        alert('月供金额不足以支付利息，无法计算减少年限方案');
                        return;
                    }
                    
                    // 只能计算减少月供方案
                    adjustedResult = `新月供: ${reducePaymentNewMonthlyPayment.toFixed(2)}元，贷款到期日${originalEndDateStr}。`;
                    newTotalPayment = reducePaymentNewTotal;
                    newInterest = reducePaymentNewInterest;
                    interestSaved = reducePaymentInterestSaved;
                    newMonthlyPayment = reducePaymentNewMonthlyPayment;
                    newPeriods = reducePaymentNewPeriods;
                    
                    // 无法计算减少年限方案，利息差额设为0
                    interestDifference = 0;
                    
                    // 生成等额本息还款计划
                    repaymentPlanData = generateEqualPrincipalAndInterestSchedule(
                        newPrincipal, monthlyRate, newPeriods, newMonthlyPayment, 
                        prepayDateObj, paymentDay
                    );
                }
            } else {
                // 等额本金计算
                // 等额本金总还款额计算
                // 首月月供 = (本金/期数) + (本金 × 月利率)
                // 每月递减额 = 本金/期数 × 月利率
                // 总还款额 = (首月月供 + 末月月供) × 期数 / 2
                const firstMonthPayment = remainingPrincipal / remainingPeriods + remainingPrincipal * monthlyRate;
                const lastMonthPayment = remainingPrincipal / remainingPeriods + (remainingPrincipal / remainingPeriods) * monthlyRate;
                originalTotalPayment = (firstMonthPayment + lastMonthPayment) * remainingPeriods / 2;
                
                // 计算原利息总额
                originalInterest = originalTotalPayment - remainingPrincipal;
                
                // 计算减少月供方案（年限不变）
                let reducePaymentNewPeriods = remainingPeriods;
                // 等额本金的新首月月供
                let reducePaymentNewFirstMonthPayment = newPrincipal / reducePaymentNewPeriods + newPrincipal * monthlyRate;
                // 等额本金的新末月月供
                let reducePaymentNewLastMonthPayment = newPrincipal / reducePaymentNewPeriods + (newPrincipal / reducePaymentNewPeriods) * monthlyRate;
                // 计算新还款计划总金额
                let reducePaymentNewTotal = (reducePaymentNewFirstMonthPayment + reducePaymentNewLastMonthPayment) * reducePaymentNewPeriods / 2;
                let reducePaymentNewInterest = reducePaymentNewTotal - newPrincipal;
                reducePaymentInterestSaved = originalInterest - reducePaymentNewInterest;
                
                // 计算减少年限方案（月供不变，这里指首月月供不变）
                let reducePeriodFirstMonthPayment = monthlyPayment;
                
                // 计算新期数
                let reducePeriodNewPeriods = Math.ceil(newPrincipal / (reducePeriodFirstMonthPayment - newPrincipal * monthlyRate));
                
                // 计算新还款计划总金额
                let reducePeriodNewFirstMonthPayment = newPrincipal / reducePeriodNewPeriods + newPrincipal * monthlyRate;
                let reducePeriodNewLastMonthPayment = newPrincipal / reducePeriodNewPeriods + (newPrincipal / reducePeriodNewPeriods) * monthlyRate;
                let reducePeriodNewTotal = (reducePeriodNewFirstMonthPayment + reducePeriodNewLastMonthPayment) * reducePeriodNewPeriods / 2;
                let reducePeriodNewInterest = reducePeriodNewTotal - newPrincipal;
                reducePeriodInterestSaved = originalInterest - reducePeriodNewInterest;
                
                // 计算两种方案利息差额
                interestDifference = reducePeriodInterestSaved - reducePaymentInterestSaved;
                
                // 计算新到期日
                const reducePeriodEndDate = calculateEndDate(prepayDateObj, reducePeriodNewPeriods);
                const reducePeriodEndDateStr = formatDate(reducePeriodEndDate);
                
                // 根据用户选择的方案显示对应的结果
                if (repaymentPlan === 'reducePayment') {
                    // 方案1：减少月供，年限不变
                    adjustedResult = `新月供(首月): ${reducePaymentNewFirstMonthPayment.toFixed(2)}元，贷款到期日${originalEndDateStr}。`;
                    newTotalPayment = reducePaymentNewTotal;
                    newInterest = reducePaymentNewInterest;
                    interestSaved = reducePaymentInterestSaved;
                    newMonthlyPayment = reducePaymentNewFirstMonthPayment;
                    newPeriods = reducePaymentNewPeriods;
                    
                    // 生成等额本金还款计划
                    repaymentPlanData = generateEqualPrincipalSchedule(
                        newPrincipal, monthlyRate, newPeriods, 
                        prepayDateObj, paymentDay
                    );
                } else {
                    // 方案2：减少年限，月供不变
                    const periodReduction = remainingPeriods - reducePeriodNewPeriods;
                    adjustedResult = `新剩余期数: ${reducePeriodNewPeriods}个月，比原期数减少${periodReduction}个月，贷款到期日${reducePeriodEndDateStr}。`;
                    newTotalPayment = reducePeriodNewTotal;
                    newInterest = reducePeriodNewInterest;
                    interestSaved = reducePeriodInterestSaved;
                    newMonthlyPayment = reducePeriodFirstMonthPayment;
                    newPeriods = reducePeriodNewPeriods;
                    
                    // 生成等额本金还款计划（使用新的期数）
                    repaymentPlanData = generateEqualPrincipalSchedule(
                        newPrincipal, monthlyRate, newPeriods, 
                        prepayDateObj, paymentDay
                    );
                }
            }
            
            // 显示结果
            document.getElementById('adjustedResult').innerHTML = adjustedResult;
            document.getElementById('resultNote').textContent = `采用"${planName}"方案，还款方式：${repaymentMethod}`;
            
            // 显示节省利息总额（按指定格式）
            document.getElementById('interestSaved').innerHTML = 
                `<span class="interest-breakdown">节省利息总额${interestSaved.toFixed(2)}元 = 原利息总额${originalInterest.toFixed(2)}元 - 调整后利息总额${newInterest.toFixed(2)}元</span>`;
            
            // 显示缩期与缩额利差
            document.getElementById('interestDifference').textContent = `${interestDifference.toFixed(2)}元`;
            
            document.getElementById('originalTotal').textContent = `${originalTotalPayment.toFixed(2)}元`;
            document.getElementById('newTotal').textContent = `${newTotalPayment.toFixed(2)}元`;
            document.getElementById('principalReduction').textContent = `${principalReductionRatio}%`;
            
            // 更新表格
            updateResultTable(
                remainingPrincipal, 
                repaymentMethod, 
                remainingPeriods, 
                annualRate, 
                monthlyPayment, 
                paymentDay, 
                prepayAmount, 
                prepayDate, 
                planName, 
                adjustedResult
            );
            
            // 更新还款计划表
            updateRepaymentPlanTable(repaymentPlanData);
        }
        
        // 生成等额本息还款计划
        function generateEqualPrincipalAndInterestSchedule(principal, monthlyRate, periods, monthlyPayment, prepayDate, paymentDayStr) {
            let schedule = [];
            let remainingPrincipal = principal;
            
            // 从paymentDayStr中提取日期数字
            const dayMatch = paymentDayStr.match(/\d+/);
            const paymentDay = dayMatch ? parseInt(dayMatch[0]) : 15;
            
            // 计算第一期还款日期
            let paymentDate = new Date(prepayDate);
            paymentDate.setMonth(paymentDate.getMonth() + 1);
            paymentDate.setDate(paymentDay);
            
            for (let i = 1; i <= periods; i++) {
                let interest = remainingPrincipal * monthlyRate;
                let principalPaid = monthlyPayment - interest;
                
                // 最后一期调整
                if (i === periods) {
                    principalPaid = remainingPrincipal;
                    monthlyPayment = principalPaid + interest;
                }
                
                remainingPrincipal -= principalPaid;
                if (remainingPrincipal < 0.01) remainingPrincipal = 0;
                
                schedule.push({
                    period: i,
                    paymentDate: formatDate(paymentDate),
                    paymentAmount: monthlyPayment,
                    principalPaid: principalPaid,
                    interestPaid: interest,
                    remainingPrincipal: remainingPrincipal
                });
                
                // 增加一个月
                paymentDate = new Date(paymentDate);
                paymentDate.setMonth(paymentDate.getMonth() + 1);
            }
            
            return schedule;
        }
        
        // 生成等额本息还款计划（最后一期不同）
        function generateEqualPrincipalAndInterestScheduleWithLastPayment(principal, monthlyRate, periods, monthlyPayment, lastPayment, prepayDate, paymentDayStr) {
            let schedule = [];
            let remainingPrincipal = principal;
            
            // 从paymentDayStr中提取日期数字
            const dayMatch = paymentDayStr.match(/\d+/);
            const paymentDay = dayMatch ? parseInt(dayMatch[0]) : 15;
            
            // 计算第一期还款日期
            let paymentDate = new Date(prepayDate);
            paymentDate.setMonth(paymentDate.getMonth() + 1);
            paymentDate.setDate(paymentDay);
            
            for (let i = 1; i <= periods; i++) {
                let interest = remainingPrincipal * monthlyRate;
                let principalPaid, paymentAmount;
                
                if (i === periods) {
                    // 最后一期
                    paymentAmount = lastPayment;
                    principalPaid = paymentAmount - interest;
                } else {
                    paymentAmount = monthlyPayment;
                    principalPaid = monthlyPayment - interest;
                }
                
                remainingPrincipal -= principalPaid;
                if (remainingPrincipal < 0.01) remainingPrincipal = 0;
                
                schedule.push({
                    period: i,
                    paymentDate: formatDate(paymentDate),
                    paymentAmount: paymentAmount,
                    principalPaid: principalPaid,
                    interestPaid: interest,
                    remainingPrincipal: remainingPrincipal
                });
                
                // 增加一个月
                paymentDate = new Date(paymentDate);
                paymentDate.setMonth(paymentDate.getMonth() + 1);
            }
            
            return schedule;
        }
        
        // 生成等额本金还款计划
        function generateEqualPrincipalSchedule(principal, monthlyRate, periods, prepayDate, paymentDayStr) {
            let schedule = [];
            let remainingPrincipal = principal;
            const monthlyPrincipal = principal / periods; // 每月应还本金
            
            // 从paymentDayStr中提取日期数字
            const dayMatch = paymentDayStr.match(/\d+/);
            const paymentDay = dayMatch ? parseInt(dayMatch[0]) : 15;
            
            // 计算第一期还款日期
            let paymentDate = new Date(prepayDate);
            paymentDate.setMonth(paymentDate.getMonth() + 1);
            paymentDate.setDate(paymentDay);
            
            for (let i = 1; i <= periods; i++) {
                let interest = remainingPrincipal * monthlyRate;
                let principalPaid = monthlyPrincipal;
                let paymentAmount = principalPaid + interest;
                
                // 最后一期调整
                if (i === periods) {
                    principalPaid = remainingPrincipal;
                    paymentAmount = principalPaid + interest;
                }
                
                remainingPrincipal -= principalPaid;
                if (remainingPrincipal < 0.01) remainingPrincipal = 0;
                
                schedule.push({
                    period: i,
                    paymentDate: formatDate(paymentDate),
                    paymentAmount: paymentAmount,
                    principalPaid: principalPaid,
                    interestPaid: interest,
                    remainingPrincipal: remainingPrincipal
                });
                
                // 增加一个月
                paymentDate = new Date(paymentDate);
                paymentDate.setMonth(paymentDate.getMonth() + 1);
            }
            
            return schedule;
        }
        
        // 计算到期日函数
        function calculateEndDate(startDate, months) {
            const endDate = new Date(startDate);
            endDate.setMonth(endDate.getMonth() + months);
            return endDate;
        }
        
        // 格式化日期函数
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}年${month}月${day}日`;
        }
        
        // 更新结果表格
        function updateResultTable(
            remainingPrincipal, 
            repaymentMethod, 
            remainingPeriods, 
            annualRate, 
            monthlyPayment, 
            paymentDay, 
            prepayAmount, 
            prepayDate, 
            planName, 
            adjustedResult
        ) {
            const tableBody = document.querySelector('#resultTable tbody');
            
            tableBody.innerHTML = `
                <tr>
                    <td>${remainingPrincipal.toFixed(2)}</td>
                    <td>${repaymentMethod}</td>
                    <td>${remainingPeriods}</td>
                    <td>${annualRate.toFixed(2)}</td>
                    <td>${monthlyPayment.toFixed(2)}</td>
                    <td>${paymentDay}</td>
                    <td>${prepayAmount.toFixed(2)}</td>
                    <td>${prepayDate}</td>
                    <td>${planName}</td>
                    <td>${adjustedResult}</td>
                </tr>
            `;
        }
        
        // 更新还款计划表
        function updateRepaymentPlanTable(repaymentPlanData) {
            const tableBody = document.querySelector('#repaymentPlanTable tbody');
            
            if (repaymentPlanData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">无还款计划数据</td></tr>';
                return;
            }
            
            let html = '';
            repaymentPlanData.forEach(item => {
                html += `
                <tr>
                    <td>第${item.period}期</td>
                    <td>${item.paymentDate}</td>
                    <td>${item.paymentAmount.toFixed(2)}</td>
                    <td>${item.principalPaid.toFixed(2)}</td>
                    <td>${item.interestPaid.toFixed(2)}</td>
                    <td>${item.remainingPrincipal.toFixed(2)}</td>
                </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }
        
        // 导出为Excel文件
        function exportToExcel() {
            // 获取表格数据
            const table = document.getElementById('resultTable');
            
            // 检查是否有数据
            const tableBody = table.querySelector('tbody');
            if (tableBody.innerHTML.includes('请先进行计算')) {
                alert('请先进行计算再导出');
                return;
            }
            
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            
            // 创建工作表数据
            const wsData = [];
            
            // 添加标题行
            const headers = [];
            table.querySelectorAll('th').forEach(th => {
                headers.push(th.textContent);
            });
            wsData.push(headers);
            
            // 添加数据行
            table.querySelectorAll('tbody tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach(td => {
                    row.push(td.textContent);
                });
                wsData.push(row);
            });
            
            // 创建工作表
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // 设置列宽
            const wscols = [
                {wch: 15}, // 剩余本金余额
                {wch: 10}, // 还款方式
                {wch: 12}, // 剩余还款期数
                {wch: 10}, // 年利率
                {wch: 15}, // 当前每月月供
                {wch: 15}, // 还款日
                {wch: 15}, // 提前还本金额
                {wch: 15}, // 提前还本日期
                {wch: 20}, // 还款方案
                {wch: 40}  // 调整后结果
            ];
            ws['!cols'] = wscols;
            
            // 将工作表添加到工作簿
            XLSX.utils.book_append_sheet(wb, ws, "房贷提前还款计算");
            
            // 生成文件名
            const today = new Date();
            const dateString = today.getFullYear() + '-' + 
                              (today.getMonth() + 1).toString().padStart(2, '0') + '-' + 
                              today.getDate().toString().padStart(2, '0');
            const fileName = `房贷提前还款计算_${dateString}.xlsx`;
            
            // 导出Excel文件
            XLSX.writeFile(wb, fileName);
        }
        
        // 导出还款计划为Excel文件
        function exportPlanToExcel() {
            const table = document.getElementById('repaymentPlanTable');
            
            // 检查是否有数据
            const tableBody = table.querySelector('tbody');
            if (tableBody.innerHTML.includes('请先进行计算') || tableBody.innerHTML.includes('无还款计划数据')) {
                alert('请先进行计算再导出还款计划');
                return;
            }
            
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            
            // 创建工作表数据
            const wsData = [];
            
            // 添加标题行
            const headers = [];
            table.querySelectorAll('th').forEach(th => {
                headers.push(th.textContent);
            });
            wsData.push(headers);
            
            // 添加数据行
            table.querySelectorAll('tbody tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach(td => {
                    row.push(td.textContent);
                });
                wsData.push(row);
            });
            
            // 创建工作表
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // 设置列宽
            const wscols = [
                {wch: 12}, // 还款期次
                {wch: 15}, // 还款日期
                {wch: 15}, // 每期还款额
                {wch: 15}, // 应还本金
                {wch: 15}, // 应还利息
                {wch: 15}  // 本金余额
            ];
            ws['!cols'] = wscols;
            
            // 将工作表添加到工作簿
            XLSX.utils.book_append_sheet(wb, ws, "还款计划表");
            
            // 生成文件名
            const today = new Date();
            const dateString = today.getFullYear() + '-' + 
                              (today.getMonth() + 1).toString().padStart(2, '0') + '-' + 
                              today.getDate().toString().padStart(2, '0');
            const fileName = `房贷还款计划表_${dateString}.xlsx`;
            
            // 导出Excel文件
            XLSX.writeFile(wb, fileName);
        }
    </script>
</body>
</html>